rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isFranchiseOwner(userId) {
      return isAuthenticated() && getUserData(userId).role == 'franchise-owner';
    }

    function isOutletAdmin(userId, outletId) {
      let data = getUserData(userId);
      return isAuthenticated() && data.role == 'outlet-admin' && data.outletId == outletId;
    }
    
    // Default deny all
    match /{document=**} {
      allow read, write: if false;
    }

    // USERS
    match /users/{userId} {
      allow read, update: if isOwner(userId);
      allow create: if isAuthenticated();
      allow list: if isFranchiseOwner(request.auth.uid);
    }
    
    // PUBLIC DATA (Cities, Outlets, Categories, Menu Items)
    match /cities/{cityId} {
        allow read: if true;
        allow write: if isFranchiseOwner(request.auth.uid);
    }
    match /outlets/{outletId} {
        allow read: if true;
        allow write: if isFranchiseOwner(request.auth.uid);
    }
    match /categories/{categoryId} {
        allow read: if true;
        allow write: if isFranchiseOwner(request.auth.uid);
    }
    match /menuItems/{menuItemId} {
        allow read: if true;
        allow write: if isFranchiseOwner(request.auth.uid);
    }

    // OUTLET MENU AVAILABILITY
    match /outlets/{outletId}/menuAvailability/{menuItemId} {
        allow read: if true;
        allow write: if isFranchiseOwner(request.auth.uid) || isOutletAdmin(request.auth.uid, outletId);
    }

    // ORDERS
    match /orders/{orderId} {
        allow create: if isAuthenticated() && request.resource.data.customerId == request.auth.uid;
        allow read: if isAuthenticated() && (
            resource.data.customerId == request.auth.uid || 
            isOutletAdmin(request.auth.uid, resource.data.outletId) ||
            isFranchiseOwner(request.auth.uid)
        );
        allow update: if isAuthenticated() && (
            isOutletAdmin(request.auth.uid, resource.data.outletId) ||
            isFranchiseOwner(request.auth.uid)
        );
    }
  }
}